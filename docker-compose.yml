services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
    container_name: posthorn_prod
    env_file:
      - .env.production
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      # So SvelteKit sees the original HTTPS request (avoids redirect loop behind Traefik)
      - PROTOCOL_HEADER=x-forwarded-proto
      - HOST_HEADER=x-forwarded-host
    volumes:
      - app_data:/app/data    # SQLite DB + media uploads persist here
    networks:
      - passbolt_default
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.posthorn-https.entrypoints=websecure"
      - "traefik.http.routers.posthorn-https.rule=Host(`post.dvadsatjeden.org`)"
      - "traefik.http.routers.posthorn-https.tls=true"
      - "traefik.http.routers.posthorn-https.tls.certresolver=letsencrypt"
      - "traefik.http.services.posthorn-https.loadbalancer.server.port=3000"

volumes:
  app_data:
    name: posthorn_data

networks:
  passbolt_default:
    external: true